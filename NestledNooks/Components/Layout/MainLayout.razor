@inherits LayoutComponentBase
@using MudBlazor
@using Microsoft.AspNetCore.Components.Routing
@inject NavigationManager Nav
@implements IDisposable

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
	<MudAppBar Elevation="4" Dense="true" Class="nn-appbar nn-appbar-sky">
		<MudIconButton Icon="@Icons.Material.Filled.Menu"
					   Color="Color.Inherit"
					   Edge="Edge.Start"
					   OnClick="ToggleDrawer" />

		<div class="nn-brand nn-brand-inline">
			<img src="/images/apple5_blue.png" alt="Logo" class="nn-logo-img" />
			<div class="nn-brand-text">
				<div class="nn-brand-title">Nestled Nooks</div>
				<div class="nn-brand-subtitle">Relax • Recharge • Reset</div>
			</div>
		</div>

		<MudSpacer />
	</MudAppBar>

	<MudDrawer Open="@_drawerOpen"
			   OpenChanged="OnDrawerOpenChanged"
			   Variant="DrawerVariant.Temporary"
			   Anchor="Anchor.Left"
			   Elevation="8"
			   Overlay="true"
			   ClipMode="DrawerClipMode.Never"
			   Width="280px"
			   Class="nn-drawer-white">

		<div class="nn-drawer-inner">

			<div class="nn-drawer-header">
				<MudText Typo="Typo.h6">Menu</MudText>
				<MudIconButton Icon="@Icons.Material.Filled.Close"
							   Color="Color.Inherit"
							   OnClick="@CloseDrawerLocal" />
			</div>

			<MudDivider />

			<MudNavMenu>

				<MudNavLink Href="/"
							Match="NavLinkMatch.All"
							Icon="@Icons.Material.Filled.Home"
							OnClick="@CloseDrawerLocal">
					Home
				</MudNavLink>

				<MudNavLink Href="/weather"
							Icon="@Icons.Material.Filled.Cloud"
							OnClick="@CloseDrawerLocal">
					Weather
				</MudNavLink>

				<MudNavLink Href="/contact"
							Icon="@Icons.Material.Filled.Email"
							OnClick="@CloseDrawerLocal">
					Contact Us
				</MudNavLink>

				<MudDivider Class="my-2" />
				<span class="text-muted">
					Guest booking coming soon
				</span>

				@* TEMP: Auth disabled until Azure DB is live *@
				@* <MudNavLink Href="/login"
							Icon="@Icons.Material.Filled.Lock"
							OnClick="@CloseDrawerLocal">
					Login
				</MudNavLink>

				<MudNavLink Href="/register"
							Icon="@Icons.Material.Filled.PersonAdd"
							OnClick="@CloseDrawerLocal">
					Register
				</MudNavLink> *@

			</MudNavMenu>
		</div>
	</MudDrawer>

	<MudMainContent>
		@Body
	</MudMainContent>

</MudLayout>

@code {
	private bool _drawerOpen;

	private void ToggleDrawer() => _drawerOpen = !_drawerOpen;
	private void OnDrawerOpenChanged(bool open) => _drawerOpen = open;

	[Parameter] public EventCallback OnNavigate { get; set; }

	[Parameter] public Action? CloseDrawer { get; set; }


	// Local helper that ensures the drawer state is updated and the optional external CloseDrawer action is invoked.
	private void CloseDrawerLocal()
	{
		_drawerOpen = false;
		CloseDrawer?.Invoke();
	}

	// Subscribe to navigation events so the drawer closes automatically on any navigation.
	protected override void OnInitialized()
	{
		base.OnInitialized();
		Nav.LocationChanged += OnLocationChanged;
	}

	private void OnLocationChanged(object? sender, LocationChangedEventArgs args)
	{
		// Ensure UI update on the renderer thread
		InvokeAsync(() =>
		{
			_drawerOpen = false;
			StateHasChanged();
		});
	}

	// Unsubscribe when disposed to avoid memory leaks.
	public void Dispose()
	{
		Nav.LocationChanged -= OnLocationChanged;
	}
}
